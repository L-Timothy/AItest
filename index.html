<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tim's AI</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
<link rel="icon" href="https://img.icons8.com/?size=100&id=fO5yVwARGUEB&format=png&color=000000" type="image/png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/default.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
    <script>hljs.highlightAll();</script>
    <style>
        /* 通用样式 */
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }

        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .topic-active {
            background-color: #4a5568;
        }

        /* 消息内容样式 */
        .message-content p {
            margin-bottom: 1em;
        }

        .message-content p:last-child {
            margin-bottom: 0;
        }

        .message-content ul,
        .message-content ol {
            margin-top: 0.5em;
            margin-bottom: 0.5em;
            padding-left: 1.5em;
        }

        .message-content li {
            margin-bottom: 0.25em;
        }

        .message-content li:last-child {
            margin-bottom: 0;
        }

        /* AI 消息样式 */
        .ai-message {
            background-color: #f7f7f7;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 16px;
            padding-bottom: 48px;
            margin-bottom: 16px;
            position: relative;
            border: 1px solid #e0e0e0;
        }

        .ai-message .message-content {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            line-height: 1.6;
            color: #333;
        }

        /* 消息操作按钮样式 */
        .message-actions {
            position: absolute;
            bottom: 12px;
            right: 16px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .icon-button {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0;
            transition: opacity 0.3s ease;
            opacity: 0.6;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .icon-button:hover {
            opacity: 1;
        }

        .icon-button svg {
            width: 20px;
            height: 20px;
        }

        /* 设置和新建主题模态框样式 */
        #settingsModal,
        #newTopicModal,
        #instructionsModal {
            z-index: 100;
        }

        #settingsModal .bg-white,
        #newTopicModal .bg-white,
        #instructionsModal .bg-white {
            width: 90%;
            max-width: 500px;
            margin: 5% auto;
            padding: 2rem;
            border-radius: 12px;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 1.5rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
        }

        .modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
        }

        .modal-buttons button {
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-weight: 600;
        }

.loader {
    border: 4px solid #f3f3f3; 
    border-top: 4px solid #3498db; 
    border-radius: 50%;
    width: 30px;
    height: 30px;
    margin: 20px auto; 
}

.loader.active { /* 添加新的类 */
    animation: spin 2s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

        /* 响应式设计 */
        @media (max-width: 768px) {
            #sidebar {
                position: fixed;
                left: -100%;
                top: 0;
                bottom: 0;
                width: 35%;
                min-width: 200px;
                max-width: 300px;
                z-index: 50;
                transition: left 0.3s ease-in-out;
            }

            #sidebar.open {
                left: 0;
            }

            #mainContent {
                width: 100%;
            }

            #sidebar h2 {
                font-size: 1.2rem;
            }

            #sidebar button,
            #topicList div {
                font-size: 0.9rem;
                padding: 0.5rem;
            }

            .bg-white.shadow-md.p-4 {
                padding: 0.5rem;
            }

            #currentTopic {
                font-size: 1.2rem;
            }

            #modelSelect {
                font-size: 0.9rem;
            }

            #chatContainer {
                height: calc(100vh - 110px);
            }

            .message {
                max-width: 90%;
            }

            .ai-message {
                padding: 0.75rem;
                padding-bottom: 2.5rem;
            }

            .message-actions {
                bottom: 0.25rem;
                right: 0.25rem;
            }

            .icon-button svg {
                width: 16px;
                height: 16px;
            }

            #userInput {
                font-size: 0.9rem;
            }

            #sendBtn {
                font-size: 0.9rem;
                padding: 0.5rem 1rem;
            }

            #settingsModal .bg-white,
            #newTopicModal .bg-white,
            #instructionsModal .bg-white {
                width: 90%;
                max-width: 350px;
                margin: 10% auto;
                padding: 1.5rem;
            }

            .modal-title {
                font-size: 1.2rem;
            }
        }

        /* Markdown 内容样式 */
        .message-content pre {
            background-color: #2d2d2d;
            color: #ccc;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
        }

        .message-content code {
            background-color: #f5f5f5;
            padding: 2px 4px;
            border-radius: 4px;
        }

        .message-content table {
            width: 100%;
            border-collapse: collapse;
        }

        .message-content th, .message-content td {
            border: 1px solid #ddd;
            padding: 8px;
        }

        .message-content th {
            background-color: #f2f2f2;
            text-align: left;
        }
    </style>
</head>

<body class="bg-gray-100">
    <div class="flex-1 flex overflow-hidden h-screen">
        <div id="sidebar"
            class="w-64 bg-gray-800 text-white p-4 flex flex-col transition-all duration-300 ease-in-out">
            <h2 id="主题列表" class="text-2xl font-bold mb-4">主题列表</h2>
            <button id="newTopicBtn"
                class="bg-blue-500 text-white px-4 py-2 rounded mb-4 hover:bg-blue-600 transition-colors duration-200">新建主题</button>
            <div id="topicList" class="flex-1 overflow-y-auto scrollbar-hide"></div>
            <button id="instructionsBtn" class="mt-2 hover:text-gray-300">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                    stroke="currentColor" class="w-6 h-6 inline-block">
                    <path stroke-linecap="round" stroke-linejoin="round"
                        d="M9.879 7.519c1.171-1.025 3.071-1.025 4.242 0 1.172 1.025 1.172 2.687 0 3.712-.203.179-.43.326-.67.442-.745.361-1.45.999-1.45 1.827v.75M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9 5.25h.008v.008H12v-.008z" />
                </svg>
                使用说明
            </button>
            <button id="settingsBtn"
                class="bg-gray-600 text-white px-4 py-2 rounded mt-2 hover:bg-gray-700 transition-colors duration-200">设置</button>
        </div>

        <div id="mainContent" class="flex-1 flex flex-col overflow-hidden">
            <div class="bg-white shadow-md p-4 flex justify-between items-center">
                <h1 id="currentTopic" class="text-2xl font-bold">AI 对话助手</h1>
                <button id="menuToggle" class="md:hidden p-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M4 6h16M4 12h16M4 18h16" />
                    </svg>
                </button>
                <div class="flex items-center">
                    <label for="modelSelect" class="mr-2">模型:</label>
                    <select id="modelSelect" class="border rounded p-1">
                    </select>
                </div>
            </div>

            <div id="chatContainer" class="flex-1 overflow-y-auto p-4 scrollbar-hide"></div>

            <div class="bg-white p-4 shadow-md">
                <div class="flex flex-col md:flex-row">
                    <textarea id="userInput" class="flex-1 border rounded p-2 mb-2 md:mb-0 md:mr-2" rows="3"
                        placeholder="输入消息..."></textarea>
                    <button id="sendBtn"
                        class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 transition-colors duration-200">发送</button>
                </div>
            </div>
        </div>
    </div>

    <div id="settingsModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center">
        <div class="bg-white p-6 rounded-lg">
            <h2 class="modal-title">设置</h2>
            <div class="form-group">
                <label for="apiKey">API Key:</label>
                <input id="apiKey" type="password" class="w-full border rounded p-2">
            </div>
            <div class="form-group">
                <label for="temperature">Temperature (0-1):</label>
                <input id="temperature" type="number" min="0" max="1" step="0.1" class="w-full border rounded p-2">
            </div>
<div class="form-group">
    <label for="apiLine">线路:</label>
    <select id="apiLine" class="w-full border rounded p-2">
        <option value="line1">线路1</option> 
        <option value="line2">线路2</option> 
        <option value="line3">线路3</option> 
        <option value="line4">线路4（免费）</option>
        <option value="line5">线路5（免费）</option>
    </select>
</div>
            <div class="modal-buttons">
                <button id="saveSettingsBtn"
                    class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 transition-colors duration-200">保存</button>
                <button id="closeSettingsBtn"
                    class="bg-gray-300 text-gray-800 px-4 py-2 rounded hover:bg-gray-400 transition-colors duration-200">关闭</button>
            </div>
        </div>
    </div>

    <div id="newTopicModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center">
        <div class="bg-white p-6 rounded-lg">
            <h2 id="新建主题" class="text-2xl font-bold mb-4">新建主题</h2>
            <div class="mb-4">
                <label for="topicName" class="block mb-2">主题名称:</label>
                <input id="topicName" type="text" class="w-full border rounded p-2">
            </div>
            <div class="flex justify-end">
                <button id="createTopicBtn"
                    class="bg-blue-500 text-white px-4 py-2 rounded mr-2 hover:bg-blue-600 transition-colors duration-200">创建</button>
                <button id="closeNewTopicBtn"
                    class="bg-gray-300 text-gray-800 px-4 py-2 rounded hover:bg-gray-400 transition-colors duration-200">取消</button>
            </div>
        </div>
    </div>

<div id="instructionsModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center">
    <div class="bg-white p-6 rounded-lg w-128">
        <h2 id="instructionsModalTitle" class="modal-title text-center">使用说明</h2> 

        <div id="instructionsPage">  
                        <div class="text-left mt-4 space-y-4">
                <p>1. 将Key输入至"设置"里面的相应位置即可使用。</p>
                <p>2. 连续多轮使用会消耗更多的额度，因为每次对话时都会涉及到上下文，因此当对话内容过长时建议新建主题重新开始对话。</p>
                <p>3. 设置里面temperature的值为0~1，值越低时，AI回答更加可靠、一致，适合查询事实或获取标准流程。值越高时，AI会产生更多样、新颖的想法，适合头脑风暴或创意写作。您可以根据需求，调节temperature。</p>
                <p>4. 价格说明：（1中文字符≈2tokens）</p>
                <table class="w-full text-left table-auto border-collapse mt-4">
                    <thead>
                        <tr>
                            <th class="bg-gray-200 p-3 border border-gray-300">模型</th>
                            <th class="bg-gray-200 p-3 border border-gray-300">提示价格</th>
                            <th class="bg-gray-200 p-3 border border-gray-300">补全价格</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td class="p-3 border border-gray-300">gpt-4o</td>
                            <td class="p-3 border border-gray-300">$5 / 1M tokens</td>
                            <td class="p-3 border border-gray-300">$15 / 1M tokens</td>
                        </tr>
                        <tr class="bg-gray-100">
                            <td class="p-3 border border-gray-300">claude-3-5-sonnet</td>
                            <td class="p-3 border border-gray-300">$3 / 1M tokens</td>
                            <td class="p-3 border border-gray-300">$15 / 1M tokens</td>
                        </tr>
                        <tr>
                            <td class="p-3 border border-gray-300">claude-3-opus</td>
                            <td class="p-3 border border-gray-300">$15 / 1M tokens</td>
                            <td class="p-3 border border-gray-300">$75 / 1M tokens</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div id="changelogPage" class="hidden">
            <div class="text-left mt-4 space-y-4">
                <p>2024-9-16: 优化了AI回复的格式。</p>
                <p>2024-9-13: 修复了线路4无法使用的bug；新增免费线路5，使用频率限制为每10s一次（限制频率所有人共享）；由于Anthropic公司政策限制，所有线路Claude模型暂不可用。</p>
                <p>2024-9-06: 修复了部分模型无法保存；对话内容无法复制和重新生成的bug。</p>
                <p>2024-9-03: 修复了众多bug，添加了日志更新，API余额查询，以及免费线路等功能。</p>
                <p>2024-8-30: 初始版本发布。</p>
            </div>
        </div>

<div id="apiQuotaPage" class="hidden">
    <div class="fullscreen-container p-6"> 
        <div class="content-container w-full max-w-md mx-auto"> 
            <div class="form-group">
                <label for="api_url" class="block mb-2 font-medium text-gray-700">选择线路:</label>
                <select id="api_url" class="w-full border rounded p-2">
                    <option value="https://kr.gptuu.com">线路1</option>
                    <option value="https://capi.swt-ai.com">线路2</option>
                    <option value="https://api.swt-ai.com">线路3</option>
                </select>
            </div>
            <div class="form-group mt-4">
                <label for="api_key" class="block mb-2 font-medium text-gray-700">API 密钥:</label>
                <input type="password" id="api_key" placeholder="输入您的 API 密钥" class="w-full border rounded p-2">
            </div>
            <div class="modal-buttons mt-6 flex justify-center"> 
                <button onclick="checkQuota()" class="bg-blue-500 text-white px-4 py-2 rounded mr-2 hover:bg-blue-600 transition-colors duration-200">检查余额</button>
                <button onclick="clearForm()" class="bg-gray-300 text-gray-800 px-4 py-2 rounded hover:bg-gray-400 transition-colors duration-200">清空表单</button>
            </div>
<div id="loader" class="loader mt-6 hidden"></div> <div id="result" class="result mt-6"></div>
            <div id="result" class="result mt-6"></div>
        </div>
    </div>
</div>

        <div class="modal-buttons mt-6 text-center">
            <button id="prevPageBtn" class="bg-gray-300 text-gray-800 px-4 py-2 rounded mr-2 hover:bg-gray-400 transition-colors duration-200 hidden">上一页</button>
            <button id="nextPageBtn" class="bg-gray-300 text-gray-800 px-4 py-2 rounded mr-2 hover:bg-gray-400 transition-colors duration-200 hidden">下一页</button>
            <button id="closeInstructionsBtn" class="bg-gray-300 text-gray-800 px-4 py-2 rounded hover:bg-gray-400 transition-colors duration-200">关闭</button>
        </div>
    </div>  
</div>



    <script>
const apiUrls = {
    line1: {
        url: 'https://opus.gptuu.com/v1/chat/completions',
        models: ['gpt-4o', 'claude-3-5-sonnet-20240620', 'claude-3-opus-20240229'],
        modelDisplayNames: { 
            'claude-3-5-sonnet-20240620': 'claude-3-5-sonnet',
            'claude-3-opus-20240229': 'claude-3-opus'
        }
    },

    line2: {
        url: 'https://capi.swt-ai.com/v1/chat/completions',
        models: ['gpt-4o', 'claude-3-5-sonnet-20240620', 'claude-3-opus-20240229'],
        modelDisplayNames: { 
            'claude-3-5-sonnet-20240620': 'claude-3-5-sonnet',
            'claude-3-opus-20240229': 'claude-3-opus'
        }
    },

    line3: {
        url: 'https://api.swt-ai.com/v1/chat/completions',
        models: ['gpt-4o', 'claude-3-5-sonnet-20240620', 'claude-3-opus-20240229'],
        modelDisplayNames: { 
            'claude-3-5-sonnet-20240620': 'claude-3-5-sonnet',
            'claude-3-opus-20240229': 'claude-3-opus'
        }
    },

    line4: {
        url: 'https://233432.xyz/api/line4/v1/chat/completions', // 添加 /line4 前缀
        models: ['gpt-4o-mini', 'gpt-4o'],
        modelDisplayNames: {
'claude-3-5-sonnet-20240620': 'claude-3-5-sonnet',
'claude-3-opus-20240229': 'claude-3-opus'
        }
    },

    line5: {
        url: 'https://233432.xyz/api/line5/v1/chat/completions', // 添加 /line5 前缀
        models: ['gpt-4o', 'gpt-4-turbo'],
        modelDisplayNames: { 
            'claude-3-5-sonnet-20240620': 'claude-3-5-sonnet',
            'claude-3-opus-20240229': 'claude-3-opus'
        }
    },

};

let currentApiUrl = localStorage.getItem('currentApiUrl') || apiUrls.line1.url; // 使用 apiUrls.line1.url 获取线路 1 的 URL
        let apiKey = localStorage.getItem('apiKey') || '';
        let temperature = parseFloat(localStorage.getItem('temperature')) || 0.7;
        let currentTopic = null;
        let topics = JSON.parse(localStorage.getItem('topics')) || [];
        let appInitialized = false;

        const chatContainer = document.getElementById('chatContainer');
        const userInput = document.getElementById('userInput');
        const sendBtn = document.getElementById('sendBtn');
        const settingsBtn = document.getElementById('settingsBtn');
        const settingsModal = document.getElementById('settingsModal');
        const apiKeyInput = document.getElementById('apiKey');
        const temperatureInput = document.getElementById('temperature');
        const apiLineSelect = document.getElementById('apiLine');
        const saveSettingsBtn = document.getElementById('saveSettingsBtn');
        const closeSettingsBtn = document.getElementById('closeSettingsBtn');
        const modelSelect = document.getElementById('modelSelect');
        const sidebar = document.getElementById('sidebar');
        const topicList = document.getElementById('topicList');
        const newTopicBtn = document.getElementById('newTopicBtn');
        const newTopicModal = document.getElementById('newTopicModal');
        const topicNameInput = document.getElementById('topicName');
        const createTopicBtn = document.getElementById('createTopicBtn');
        const closeNewTopicBtn = document.getElementById('closeNewTopicBtn');
        const currentTopicElement = document.getElementById('currentTopic');
        const menuToggle = document.getElementById('menuToggle');
        const mainContent = document.getElementById('mainContent');
        const instructionsBtn = document.getElementById('instructionsBtn');
const instructionsModalContainer = document.getElementById('instructionsModal'); 
        const closeInstructionsBtn = document.getElementById('closeInstructionsBtn');

const instructionsModalTitle = document.getElementById('instructionsModalTitle'); // 获取标题元素
const instructionsPage = document.getElementById('instructionsPage'); 
const changelogContent = document.getElementById('changelogPage'); 
const apiQuotaContent = document.getElementById('apiQuotaPage'); 
const prevPageBtn = document.getElementById('prevPageBtn');
const nextPageBtn = document.getElementById('nextPageBtn');

let currentPage = instructionsPage; // 初始页面

        function preprocessAIResponse(content) {
            // 移除不必要的预处理，直接返回原始内容
            return content;
        }

        function addMessage(content, isUser = false, shouldSave = true) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('mb-4', 'message', isUser ? 'ml-auto' : 'mr-auto');

            if (isUser) {
                messageDiv.innerHTML = `
            <div class="rounded-lg p-3 bg-blue-100 text-blue-800">
                <div class="message-content">${marked.parse(content)}</div>
            </div>
        `;
            } else {
                const messageId = 'msg-' + Date.now();
                const processedContent = preprocessAIResponse(content);
                const htmlContent = marked.parse(processedContent, { breaks: true });
                messageDiv.innerHTML = `
            <div class="ai-message">
                <div class="message-content" id="${messageId}">${htmlContent}</div>
                <div class="message-actions">
                    <button class="icon-button regenerate-button" data-message-id="${messageId}" title="重新生成">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                        </svg>
                    </button>
                    <button class="icon-button copy-button" data-message-id="${messageId}" title="复制">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                        </svg>
                    </button>
                </div>
            </div>
        `;

                addCopyButtonListener(messageDiv.querySelector('.copy-button'));
                addRegenerateButtonListener(messageDiv.querySelector('.regenerate-button'));
                hljs.highlightAll(); // 触发代码高亮
            }

            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;

            if (currentTopic && shouldSave) {
                currentTopic.messages.push({ role: isUser ? 'user' : 'assistant', content: isUser ? content : processedContent });
                saveTopic(currentTopic);
            }
        }

        function addCopyButtonListener(button) {
            button.addEventListener('click', function () {
                const messageId = this.getAttribute('data-message-id');
                const messageToCopy = document.getElementById(messageId);
                const range = document.createRange();
                range.selectNode(messageToCopy);
                window.getSelection().removeAllRanges();
                window.getSelection().addRange(range);
                document.execCommand('copy');
                window.getSelection().removeAllRanges();

                this.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
            </svg>
        `;
                setTimeout(() => {
                    this.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                </svg>
            `;
                }, 2000);
            });
        }

function addRegenerateButtonListener(button, isError) {
    button.addEventListener('click', function () {
        const messageId = this.getAttribute('data-message-id');
        const messageElement = document.getElementById(messageId);

        // 获取最后一条用户消息
        const lastUserMessage = currentTopic.messages.filter(msg => msg.role === 'user').pop();

        if (lastUserMessage) {
            // 移除当前助手消息（即使是出错信息）
            messageElement.closest('.ai-message').remove();

            if (isError) {
                // 如果是错误情况，不需要移除消息历史
            } else {
                // 移除 messages 数组中的最后两条消息（用户消息和AI回复）
                currentTopic.messages.pop(); 
                currentTopic.messages.pop(); 
            }

            // 重新发送最后一条用户消息
            sendMessage(lastUserMessage.content); 
        }
    });
}

function checkQuota() {
    const apiUrl = document.getElementById('api_url').value;
    const apiKey = document.getElementById('api_key').value;

    const resultDiv = document.getElementById('result');
    const loader = document.getElementById('loader');

    resultDiv.style.display = 'none';
    loader.style.display = 'block';
    loader.classList.add('active'); // 显示加载动画

    fetch('https://233432.xyz/api', { // 替换为你的 Cloudflare Worker URL
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            apiUrl: apiUrl,
            apiKey: apiKey
        })
    })
    .then(response => response.json())
    .then(data => {
        loader.classList.remove('active'); // 隐藏加载动画
        loader.style.display = 'none';
        if (data.error) {
            resultDiv.innerHTML = `<span class="text-red-500">检查额度失败: ${data.error}</span>`;
        } else {
            resultDiv.innerHTML = `
                <p class="font-medium">可用额度: <span class="text-green-500">$${data.remain}</span></p>
                <p class="font-medium">已用额度: <span class="text-yellow-500">$${data.used}</span></p>
                <p class="font-medium">总额度: <span class="text-blue-500">$${data.quota}</span></p>
            `;
        }
        resultDiv.style.display = 'block';
    })
    .catch(error => {
        loader.classList.remove('active'); // 隐藏加载动画
        loader.style.display = 'none';
        resultDiv.innerHTML = `<span class="text-red-500">检查额度失败: ${error.message}</span>`;
        resultDiv.style.display = 'block';
    });
}

function clearForm() {
    document.getElementById('api_key').value = '';
    document.getElementById('result').style.display = 'none';
    document.getElementById('loader').classList.remove('active');
}

async function sendMessage(message = null) {
    const userMessage = message || userInput.value.trim();
    if (!userMessage) return;

    if (!message) {
        addMessage(userMessage, true);
        userInput.value = '';
    }

    // 检查是否已经有主题，如果没有则创建一个默认主题
    if (!currentTopic) {
        createTopic('默认主题');
    }

    // 添加用户消息到历史记录
    currentTopic.messages.push({ role: 'user', content: userMessage });
    saveTopic(currentTopic);

    const messageId = 'msg-' + Date.now();
    const aiMessageDiv = document.createElement('div');
    aiMessageDiv.classList.add('mb-4', 'message', 'mr-auto');
    aiMessageDiv.innerHTML = `
        <div class="ai-message">
            <div class="message-content" id="${messageId}">AI正在思考中...</div>
            <div class="message-actions">
                <button class="icon-button regenerate-button" data-message-id="${messageId}" title="重新生成">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                    </svg>
                </button>
                <button class="icon-button copy-button" data-message-id="${messageId}" title="复制">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                    </svg>
                </button>
            </div>
        </div>
    `;
    chatContainer.appendChild(aiMessageDiv);
    chatContainer.scrollTop = chatContainer.scrollHeight;

    let isError = false;
    let aiMessage = '';

    try {
        const decryptedApiKey = await decryptApiKey(); // 解密 API Key

        const response = await fetch(currentApiUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${decryptedApiKey}` // 使用解密后的 API Key
            },
            body: JSON.stringify({
                model: modelSelect.value,
                messages: currentTopic.messages,
                temperature: temperature,
                stream: true
            })
        });

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const reader = response.body.getReader();
        const decoder = new TextDecoder();

        while (true) {
            const { done, value } = await reader.read();
            if (done) break;

            const chunk = decoder.decode(value);
            const lines = chunk.split('\n');
            const parsedLines = lines
                .map(line => line.replace(/^data: /, '').trim())
                .filter(line => line !== '' && line !== '[DONE]')
                .map(line => {
                    try {
                        return JSON.parse(line);
                    } catch (e) {
                        console.error('Error parsing JSON:', e);
                        return null;
                    }
                })
                .filter(line => line !== null);

            for (const parsedLine of parsedLines) {
                const { choices } = parsedLine;
                if (choices && choices.length > 0) {
                    const { delta } = choices[0];
                    const { content } = delta;
                    if (content) {
                        aiMessage += content;
                        document.getElementById(messageId).innerHTML = marked.parse(preprocessAIResponse(aiMessage));
                    }
                }
            }
        }

        // 只在成功接收到完整回复后添加 AI 消息到历史记录
        if (aiMessage) {
            currentTopic.messages.push({ role: 'assistant', content: aiMessage });
            currentTopic.model = modelSelect.value;
            saveTopic(currentTopic);
        }

    } catch (error) {
        console.error('Error:', error);
        isError = true;
        if (error.message === '请在设置里填入正确的 API Key') {
            document.getElementById(messageId).innerHTML = `请在设置里填入正确的 API Key`;
        } else {
            document.getElementById(messageId).innerHTML = `抱歉，发生了错误：${error.message}`;
        }
        // 如果发生错误，移除之前添加的用户消息
        currentTopic.messages.pop();
        saveTopic(currentTopic);
    } finally {
        addCopyButtonListener(aiMessageDiv.querySelector('.copy-button'));
        addRegenerateButtonListener(aiMessageDiv.querySelector('.regenerate-button'), isError);
    }
}

function showPage(page) {
    // 只在当前页面发生改变时才隐藏所有页面
    if (currentPage !== page) {
        // 隐藏所有页面
        instructionsPage.classList.add('hidden');
        changelogContent.classList.add('hidden');
        apiQuotaContent.classList.add('hidden');

        // 更新当前页面  
        currentPage = page; 
    }

    // 显示目标页面
    page.classList.remove('hidden');

    // 更新标题
    if (page === instructionsPage) {  
        if (instructionsModalTitle.textContent !== "使用说明") {
            instructionsModalTitle.textContent = "使用说明";
        }
    } else if (page === changelogContent) {
        if (instructionsModalTitle.textContent !== "更新日志") {
            instructionsModalTitle.textContent = "更新日志";
        }
    } else if (page === apiQuotaContent) {
        if (instructionsModalTitle.textContent !== "API 余额查询") {
            instructionsModalTitle.textContent = "API 余额查询";
        }
    }

    // 更新按钮状态
    prevPageBtn.classList.toggle('hidden', currentPage === instructionsPage);
    nextPageBtn.classList.toggle('hidden', currentPage === apiQuotaContent);
}


prevPageBtn.addEventListener('click', () => {  
        if (currentPage === changelogContent) {
            showPage(instructionsPage); // 调用 showPage 函数
        } else if (currentPage === apiQuotaContent) {
            showPage(changelogContent); // 调用 showPage 函数
        }
    });

    nextPageBtn.addEventListener('click', () => {  
        if (currentPage === instructionsPage) {
            showPage(changelogContent); // 调用 showPage 函数
        } else if (currentPage === changelogContent) {
            showPage(apiQuotaContent); // 调用 showPage 函数
        }
    });

        function createTopic(name) {
            const topic = {
                id: Date.now(),
                name: name,
                messages: [],
                model: modelSelect.value
            };
            topics.push(topic);
            saveTopic(topic);
            renderTopicList();
            switchTopic(topic);
        }

        function saveTopic(topic) {
            const index = topics.findIndex(t => t.id === topic.id);
            if (index !== -1) {
                topics[index] = { ...topic };
            } else {
                topics.push({ ...topic });
            }
            localStorage.setItem('topics', JSON.stringify(topics));
        }

function switchTopic(topic) {
    if (currentTopic && currentTopic.id === topic.id) {
        return;
    }

    currentTopic = topic;
    chatContainer.innerHTML = '';

    if (topic) {
        currentTopicElement.textContent = topic.name;
        topic.messages.forEach((msg, index) => {
            // 只有当这条消息不是用户消息，或者是用户消息但前一条不是用户消息时才添加
            if (msg.role !== 'user' || index === 0 || topic.messages[index - 1].role !== 'user') {
                addMessage(msg.content, msg.role === 'user', false);
            }
        });
        if (topic.model) {
            modelSelect.value = topic.model;
        }
    } else {
        currentTopicElement.textContent = 'AI 对话助手';
    }

    renderTopicList();
}

function renderTopicList() {
    topicList.innerHTML = ''; // 清空主题列表容器
    topics.forEach(topic => {
        // 创建主题项的 div 元素
        const topicDiv = document.createElement('div');
        topicDiv.classList.add('flex', 'justify-between', 'items-center', 'mb-2', 'p-2', 'rounded', 'cursor-pointer', 'hover:bg-gray-600', 'transition-colors', 'duration-200', 'topic-item'); 
        
        // 如果是当前主题，添加 active 类
        if (currentTopic && currentTopic.id === topic.id) {
            topicDiv.classList.add('topic-active');
        } else {
            topicDiv.classList.add('bg-gray-700');
        }

        topicDiv.dataset.topicId = topic.id; // 添加 data-topic-id 属性
        topicDiv.innerHTML = `
            <span class="flex-grow">${topic.name}</span>
            <button class="edit-topic-btn mr-2 hover:text-gray-300" data-topic-id="${topic.id}">
                <i class="fas fa-pencil-alt"></i> 
            </button>
            <button class="delete-topic-btn text-red-500 hover:text-red-700" data-topic-id="${topic.id}">
                <i class="fas fa-trash-alt"></i> 
            </button>
        `;

        // 先将 topicDiv 添加到 topicList 中
        topicList.appendChild(topicDiv); 

        // 添加编辑主题名称功能 (直接绑定到按钮上)
        const editTopicBtn = topicDiv.querySelector('.edit-topic-btn'); 
        editTopicBtn.addEventListener('click', (event) => {
            event.stopPropagation(); // 阻止事件冒泡到 topicList
            const newTopicName = prompt("请输入新的主题名称:", topic.name);
            if (newTopicName && newTopicName.trim() !== "") {
                topic.name = newTopicName.trim();
                saveTopic(topic);
                renderTopicList(); // 修改主题后重新渲染列表
            }
        });
    });
}

function deleteTopic(topicId) {
  // 添加确认弹窗
  if (confirm(`确定要删除主题 "${topics.find(t => t.id === topicId).name}" 吗？`)) {
    topics = topics.filter(t => t.id !== topicId);
    localStorage.setItem('topics', JSON.stringify(topics));

    // 检查是否删除了最后一个主题
    if (topics.length === 0) {
      createTopic('默认主题'); // 创建一个新的默认主题
    } else {
      // 切换到第一个主题
      switchTopic(topics[0]); 
    }
  }
}

function setupModalListeners(modalId, openBtnId, closeBtnId) {
    const modal = document.getElementById(modalId);
    const openBtn = document.getElementById(openBtnId);
    const closeBtn = document.getElementById(closeBtnId);

    openBtn.addEventListener('click', () => {
        modal.classList.remove('hidden');
        modal.classList.add('flex');
        showPage(instructionsPage); // 打开模态框时默认显示使用说明页面
    });

        closeBtn.addEventListener('click', () => {
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        });

        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }
        });
   

            function closeModal() {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }
        }

        setupModalListeners('settingsModal', 'settingsBtn', 'closeSettingsBtn');
        setupModalListeners('newTopicModal', 'newTopicBtn', 'closeNewTopicBtn');
        setupModalListeners('instructionsModal', 'instructionsBtn', 'closeInstructionsBtn');

function initializeApp() {
    if (appInitialized) return;

    topics = JSON.parse(localStorage.getItem('topics')) || [];

    // 检查 topics 是否为空，如果为空则创建默认主题
    if (topics.length === 0) {
        const defaultTopic = {
            id: Date.now(),
            name: '默认主题',
            messages: [],
            model: apiUrls[Object.keys(apiUrls)[0]].models[0] // 使用第一线路的第一个模型作为默认模型
        };
        topics.push(defaultTopic);
        saveTopic(defaultTopic); // 保存默认主题到 localStorage
    }

    renderTopicList();
    if (topics.length > 0) {
        switchTopic(topics[0]); // 切换到第一个主题（现在是默认主题）
    }

    apiKey = localStorage.getItem('apiKey') || '';
    temperature = parseFloat(localStorage.getItem('temperature')) || 0.7;

    // 获取存储的线路 URL，如果没有则使用线路选择下拉列表中的默认值
    const storedApiUrl = localStorage.getItem('currentApiUrl');
    const defaultApiUrl = apiUrls[apiLineSelect.value].url; // 使用 apiLineSelect.value 获取默认线路的 URL
    currentApiUrl = storedApiUrl || defaultApiUrl; 

    apiKeyInput.value = apiKey;
    temperatureInput.value = temperature;

    // 设置 API Key 输入框的可见性
    const apiKeyInputDiv = document.getElementById('apiKey').parentElement;
    const storedLine = localStorage.getItem('currentApiUrl') ? 
        Object.keys(apiUrls).find(key => apiUrls[key].url === localStorage.getItem('currentApiUrl')) : 
        'line1'; // 如果没有存储线路信息，则默认为 'line1'
    if (storedLine === 'line4' || storedLine === 'line5') {
        apiKeyInputDiv.style.display = 'none'; // 隐藏 API Key 输入框
    } else {
        apiKeyInputDiv.style.display = 'block'; // 显示 API Key 输入框
    }

    // 确保在 currentApiUrl 初始化后再更新模型下拉列表
    updateModelSelect(); 

    appInitialized = true;
}

function updateModelSelect() {
    modelSelect.innerHTML = ''; // 清空下拉列表

    // 找到与 currentApiUrl 匹配的线路名称
    let lineName = '';
    for (const key in apiUrls) {
        if (apiUrls[key].url === currentApiUrl) {
            lineName = key;
            break;
        }
    }

    // 使用线路名称获取模型列表和模型显示名称的映射关系
    const models = apiUrls[lineName].models;
    const modelDisplayNames = apiUrls[lineName].modelDisplayNames || {}; // 从 apiUrls 对象中获取 modelDisplayNames

    models.forEach(model => {
        const option = document.createElement('option');
        option.value = model; // 实际模型名称
        option.text = modelDisplayNames[model] || model; // 显示模型名称，如果找不到映射关系，则使用实际模型名称
        modelSelect.appendChild(option);
    });

    // 设置线路选择下拉列表的默认值
    apiLineSelect.value = lineName; 
}

    topicList.addEventListener('click', (event) => {
        if (event.target.closest('.topic-item')) {
            const topicId = event.target.closest('.topic-item').dataset.topicId;
            const topic = topics.find(t => t.id === parseInt(topicId));
            switchTopic(topic);
        }
        if (event.target.closest('.delete-topic-btn')) {
            const topicId = event.target.closest('.delete-topic-btn').dataset.topicId;
            deleteTopic(parseInt(topicId));
        }
    });

        sendBtn.addEventListener('click', () => sendMessage());
        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

settingsBtn.addEventListener('click', () => {
    apiKeyInput.value = "****************"; // 使用星号掩盖 API Key
    temperatureInput.value = temperature;

    // 找到与 currentApiUrl 匹配的线路名称
    for (const lineName in apiUrls) {
        if (apiUrls[lineName].url === currentApiUrl) {
            apiLineSelect.value = lineName;
            break;
        }
    }

    settingsModal.classList.remove('hidden');
    settingsModal.classList.add('flex');
});

saveSettingsBtn.addEventListener('click', () => {
    apiKey = apiKeyInput.value;
    temperature = parseFloat(temperatureInput.value);

    // 获取选中的线路名称
    const selectedLine = apiLineSelect.value; 
    currentApiUrl = apiUrls[selectedLine].url; // 根据线路名称获取 URL

    if (apiKey) {
        encryptApiKey(apiKey)
            .then(() => {
                localStorage.removeItem('apiKey'); 
            })
            .catch(error => {
                console.error('加密 API Key 失败:', error);
            });
    }
    localStorage.setItem('temperature', temperature);
    localStorage.setItem('currentApiUrl', currentApiUrl); // 将当前线路 URL 存储到 localStorage
    settingsModal.classList.add('hidden');
    settingsModal.classList.remove('flex');

    updateModelSelect(); // 更新模型选择下拉列表 
});

        closeSettingsBtn.addEventListener('click', () => {
            settingsModal.classList.add('hidden');
            settingsModal.classList.remove('flex');
        });

        newTopicBtn.addEventListener('click', () => {
            newTopicModal.classList.remove('hidden');
            newTopicModal.classList.add('flex');
        });

        createTopicBtn.addEventListener('click', () => {
            const topicName = topicNameInput.value.trim();
            if (topicName) {
                createTopic(topicName);
                topicNameInput.value = '';
                newTopicModal.classList.add('hidden');
                newTopicModal.classList.remove('flex');
            }
        });

        closeNewTopicBtn.addEventListener('click', () => {
            topicNameInput.value = '';
            newTopicModal.classList.add('hidden');
            newTopicModal.classList.remove('flex');
        });

        menuToggle.addEventListener('click', (e) => {
            e.stopPropagation();
            sidebar.classList.toggle('open');
            document.body.style.overflow = sidebar.classList.contains('open') ? 'hidden' : '';
        });

        mainContent.addEventListener('click', () => {
            if (sidebar.classList.contains('open')) {
                sidebar.classList.remove('open');
                document.body.style.overflow = '';
            }
        });

        sidebar.addEventListener('click', (e) => {
            e.stopPropagation();
        });

        modelSelect.addEventListener('change', function () {
            if (currentTopic) {
                currentTopic.model = this.value;
                saveTopic(currentTopic);
            }
        });

        // 加密 API Key
        async function encryptApiKey(apiKey) {
            // 生成密钥
            const key = await crypto.subtle.generateKey(
                {
                    name: 'AES-GCM',
                    length: 256,
                },
                true,
                ['encrypt', 'decrypt']
            );

            // 加密数据
            const encodedApiKey = new TextEncoder().encode(apiKey);
            const iv = crypto.getRandomValues(new Uint8Array(12));
            const ciphertext = await crypto.subtle.encrypt(
                {
                    name: 'AES-GCM',
                    iv: iv,
                },
                key,
                encodedApiKey
            );

            // 存储加密数据和密钥信息到 localStorage
            localStorage.setItem('encryptedApiKey', JSON.stringify({
                ciphertext: Array.from(new Uint8Array(ciphertext)),
                iv: Array.from(iv),
            }));

            // 将密钥导出为 JWK 格式，以便后续导入
            const exportedKey = await crypto.subtle.exportKey('jwk', key);
            localStorage.setItem('apiKeyKey', JSON.stringify(exportedKey));
        }

// 解密 API Key
async function decryptApiKey() {
    // 从 localStorage 获取加密数据和密钥信息
    const encryptedApiKey = localStorage.getItem('encryptedApiKey');
    const apiKeyKey = localStorage.getItem('apiKeyKey');

    // 检查是否存储了加密数据和密钥信息
    if (!encryptedApiKey || !apiKeyKey) {
        throw new Error('请在设置里填入正确的 API Key');
    }

    try {
        const { ciphertext, iv } = JSON.parse(encryptedApiKey);
        const jwkKey = JSON.parse(apiKeyKey);

        // 导入密钥
        const key = await crypto.subtle.importKey(
            'jwk',
            jwkKey,
            {
                name: 'AES-GCM',
            },
            true,
            ['encrypt', 'decrypt']
        );

        // 解密数据
        const decryptedApiKey = await crypto.subtle.decrypt(
            {
                name: 'AES-GCM',
                iv: new Uint8Array(iv),
            },
            key,
            new Uint8Array(ciphertext)
        );

        // 将解密后的数据转换为字符串
        return new TextDecoder().decode(decryptedApiKey);
    } catch (error) {
        // 解密失败，可能是 API Key 错误
        throw new Error('请在设置里填入正确的 API Key');
    }
}

        // 在页面加载完成后初始化应用
        window.addEventListener('load', initializeApp);

apiLineSelect.addEventListener('change', () => {
    const apiKeyInputDiv = document.getElementById('apiKey').parentElement;
    if (apiLineSelect.value === 'line4' || apiLineSelect.value === 'line5') {
        apiKeyInputDiv.style.display = 'none'; // 隐藏 API Key 输入框
    } else {
        apiKeyInputDiv.style.display = 'block'; // 显示 API Key 输入框
        apiKeyInput.value = ""; // 清空 API Key 输入框
    }
});
    </script>
</body>

</html>
